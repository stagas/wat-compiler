var d={"type.i32":127,"type.i64":126,"type.f32":125,"type.f64":124,"type.void":64,"type.func":96,"type.funcref":112,"section.custom":0,"section.type":1,"section.import":2,"section.function":3,"section.table":4,"section.memory":5,"section.global":6,"section.export":7,"section.start":8,"section.element":9,"section.code":10,"section.data":11,"import.func":0,"import.table":1,"import.memory":2,"import.global":3,"export.function":0,"export.table":1,"export.memory":2,"export.global":3,"global.const":0,"global.var":1,"global.mut":1,"limits.min":0,"limits.minmax":1,"limits.shared":3},z=["unreachable","nop","block","loop","if","else",,,,,,"end","br","br_if","br_table","return","call","call_indirect",,,,,,,,,"drop","select",,,,,"local.get","local.set","local.tee","global.get","global.set",,,,"i32.load","i64.load","f32.load","f64.load","i32.load8_s","i32.load8_u","i32.load16_s","i32.load16_u","i64.load8_s","i64.load8_u","i64.load16_s","i64.load16_u","i64.load32_s","i64.load32_u","i32.store","i64.store","f32.store","f64.store","i32.store8","i32.store16","i64.store8","i64.store16","i64.store32","memory.size","memory.grow","i32.const","i64.const","f32.const","f64.const","i32.eqz","i32.eq","i32.ne","i32.lt_s","i32.lt_u","i32.gt_s","i32.gt_u","i32.le_s","i32.le_u","i32.ge_s","i32.ge_u","i64.eqz","i64.eq","i64.ne","i64.lt_s","i64.lt_u","i64.gt_s","i64.gt_u","i64.le_s","i64.le_u","i64.ge_s","i64.ge_u","f32.eq","f32.ne","f32.lt","f32.gt","f32.le","f32.ge","f64.eq","f64.ne","f64.lt","f64.gt","f64.le","f64.ge","i32.clz","i32.ctz","i32.popcnt","i32.add","i32.sub","i32.mul","i32.div_s","i32.div_u","i32.rem_s","i32.rem_u","i32.and","i32.or","i32.xor","i32.shl","i32.shr_s","i32.shr_u","i32.rotl","i32.rotr","i64.clz","i64.ctz","i64.popcnt","i64.add","i64.sub","i64.mul","i64.div_s","i64.div_u","i64.rem_s","i64.rem_u","i64.and","i64.or","i64.xor","i64.shl","i64.shr_s","i64.shr_u","i64.rotl","i64.rotr","f32.abs","f32.neg","f32.ceil","f32.floor","f32.trunc","f32.nearest","f32.sqrt","f32.add","f32.sub","f32.mul","f32.div","f32.min","f32.max","f32.copysign","f64.abs","f64.neg","f64.ceil","f64.floor","f64.trunc","f64.nearest","f64.sqrt","f64.add","f64.sub","f64.mul","f64.div","f64.min","f64.max","f64.copysign","i32.wrap_i64","i32.trunc_f32_s","i32.trunc_f32_u","i32.trunc_f64_s","i32.trunc_f64_u","i64.extend_i32_s","i64.extend_i32_u","i64.trunc_f32_s","i64.trunc_f32_u","i64.trunc_f64_s","i64.trunc_f64_u","f32.convert_i32_s","f32.convert_i32_u","f32.convert_i64_s","f32.convert_i64_u","f32.demote_f64","f64.convert_i32_s","f64.convert_i32_u","f64.convert_i64_s","f64.convert_i64_u","f64.promote_f32","i32.reinterpret_f32","i64.reinterpret_f64","f32.reinterpret_i32","f64.reinterpret_i64"],N={get_local:"local.get",set_local:"local.set",tee_local:"local.tee",get_global:"global.get",set_global:"global.set","i32.trunc_s/f32":"i32.trunc_f32_s","i32.trunc_u/f32":"i32.trunc_f32_u","i32.trunc_s/f64":"i32.trunc_f64_s","i32.trunc_u/f64":"i32.trunc_f64_u","i64.extend_s/i32":"i64.extend_i32_s","i64.extend_u/i32":"i64.extend_i32_u","i64.trunc_s/f32":"i64.trunc_f32_s","i64.trunc_u/f32":"i64.trunc_f32_u","i64.trunc_s/f64":"i64.trunc_f64_s","i64.trunc_u/f64":"i64.trunc_f64_u","f32.convert_s/i32":"f32.convert_i32_s","f32.convert_u/i32":"f32.convert_i32_u","f32.convert_s/i64":"f32.convert_i64_s","f32.convert_u/i64":"f32.convert_i64_u","f32.demote/f64":"f32.demote_f64","f64.convert_s/i32":"f64.convert_i32_s","f64.convert_u/i32":"f64.convert_i32_u","f64.convert_s/i64":"f64.convert_i64_s","f64.convert_u/i64":"f64.convert_i64_u","f64.promote/f32":"f64.promote_f32"};for(let[s,e]of z.entries())e!=null&&(d[e]=s);for(let s in N){let e=z.indexOf(N[s]);d[s]=e}var v={};for(let s in d){v[s]=A(s);let[e,t]=s.split(".");t!=null&&(d[e]=d[e]??{},d[e][t]=d[s],v[e]=v[e]??{},v[e][t]=A(s))}var L={"i32.load":4,"i64.load":8,"f32.load":4,"f64.load":8,"i32.load8_s":1,"i32.load8_u":1,"i32.load16_s":2,"i32.load16_u":2,"i64.load8_s":1,"i64.load8_u":1,"i64.load16_s":2,"i64.load16_u":2,"i64.load32_s":4,"i64.load32_u":4,"i32.store":4,"i64.store":8,"f32.store":4,"f64.store":8,"i32.store8":1,"i32.store16":2,"i64.store8":1,"i64.store16":2,"i64.store32":4};function*M(s){for(s=Y(s);;){let e=Number(s&0x7Fn);if(s>>=7n,s===0n&&(e&64)===0||s===-1n&&(e&64)!==0){yield e;break}yield e|128}}function*R(s){let e=0,t=Math.ceil(Math.log2(Math.abs(s))),r=s<0,c=!0;for(;c;)e=s&127,s=s>>7,r&&(s=s|-(1<<t-7)),s==0&&(e&64)==0||s==-1&&(e&64)==64?c=!1:e=e|128,yield e}function*x(s,e=0){if(s<0)throw new TypeError("uint value must be positive, received: "+s);let t=0;do t=s&127,s=s>>7,(s!=0||e>0)&&(t=t|128),yield t,e--;while(s!=0||e>-1)}var k=new DataView(new BigInt64Array(1).buffer);function Y(s){return k.setBigInt64(0,s),k.getBigInt64(0)}function*S(s){k.setFloat32(0,s);for(let e=4;e--;)yield k.getUint8(e)}function*q(s){k.setFloat64(0,s);for(let e=8;e--;)yield k.getUint8(e)}function C(s){s=s.toUpperCase();let e=s.indexOf("P"),t,r;e!==-1?(t=s.substring(0,e),r=parseInt(s.substring(e+1))):(t=s,r=0);let c=t.indexOf(".");if(c!==-1){let _=parseInt(t.substring(0,c),16),g=Math.sign(_);_=g*_;let y=t.length-c-1,o=parseInt(t.substring(c+1),16),f=y>0?o/Math.pow(16,y):0;g===0?f===0?t=g:Object.is(g,-0)?t=-f:t=f:t=g*(_+f)}else t=parseInt(t,16);return t*(e!==-1?Math.pow(2,r):1)}var H=2147483648,J=2139095040;function*G(s){let e=parseInt(s.split("nan:")[1]);e|=J,s[0]==="-"&&(e|=H),k.setInt32(0,e);for(let t=4;t--;)yield k.getUint8(t)}var W=0x8000000000000000n,X=0x7ff0000000000000n;function*P(s){let e=BigInt(s.split("nan:")[1]);e|=X,s[0]==="-"&&(e|=W),k.setBigInt64(0,e);for(let t=8;t--;)yield k.getUint8(t)}(function(s){function e(){}function t(o,f){if(o=o===void 0?"utf-8":o,f=f===void 0?{fatal:!1}:f,g.indexOf(o.toLowerCase())===-1)throw new RangeError("Failed to construct 'TextDecoder': The encoding label provided ('"+o+"') is invalid.");if(f.fatal)throw Error("Failed to construct 'TextDecoder': the 'fatal' option is unsupported.")}function r(o){return Buffer.from(o.buffer,o.byteOffset,o.byteLength).toString("utf-8")}function c(o){var f=URL.createObjectURL(new Blob([o],{type:"text/plain;charset=UTF-8"}));try{var i=new XMLHttpRequest;return i.open("GET",f,!1),i.send(),i.responseText}catch{return _(o)}finally{URL.revokeObjectURL(f)}}function _(o){for(var f=0,i=Math.min(65536,o.length+1),n=new Uint16Array(i),u=[],a=0;;){var l=f<o.length;if(!l||a>=i-1){if(u.push(String.fromCharCode.apply(null,n.subarray(0,a))),!l)return u.join("");o=o.subarray(f),a=f=0}if(l=o[f++],(l&128)===0)n[a++]=l;else if((l&224)===192){var p=o[f++]&63;n[a++]=(l&31)<<6|p}else if((l&240)===224){p=o[f++]&63;var m=o[f++]&63;n[a++]=(l&31)<<12|p<<6|m}else if((l&248)===240){p=o[f++]&63,m=o[f++]&63;var w=o[f++]&63;l=(l&7)<<18|p<<12|m<<6|w,65535<l&&(l-=65536,n[a++]=l>>>10&1023|55296,l=56320|l&1023),n[a++]=l}}}if(s.TextEncoder&&s.TextDecoder)return!1;var g=["utf-8","utf8","unicode-1-1-utf-8"];Object.defineProperty(e.prototype,"encoding",{value:"utf-8"}),e.prototype.encode=function(o,f){if(f=f===void 0?{stream:!1}:f,f.stream)throw Error("Failed to encode: the 'stream' option is unsupported.");f=0;for(var i=o.length,n=0,u=Math.max(32,i+(i>>>1)+7),a=new Uint8Array(u>>>3<<3);f<i;){var l=o.charCodeAt(f++);if(55296<=l&&56319>=l){if(f<i){var p=o.charCodeAt(f);(p&64512)===56320&&(++f,l=((l&1023)<<10)+(p&1023)+65536)}if(55296<=l&&56319>=l)continue}if(n+4>a.length&&(u+=8,u*=1+f/o.length*2,u=u>>>3<<3,p=new Uint8Array(u),p.set(a),a=p),(l&4294967168)===0)a[n++]=l;else{if((l&4294965248)===0)a[n++]=l>>>6&31|192;else if((l&4294901760)===0)a[n++]=l>>>12&15|224,a[n++]=l>>>6&63|128;else if((l&4292870144)===0)a[n++]=l>>>18&7|240,a[n++]=l>>>12&63|128,a[n++]=l>>>6&63|128;else continue;a[n++]=l&63|128}}return a.slice?a.slice(0,n):a.subarray(0,n)},Object.defineProperty(t.prototype,"encoding",{value:"utf-8"}),Object.defineProperty(t.prototype,"fatal",{value:!1}),Object.defineProperty(t.prototype,"ignoreBOM",{value:!1});var y=_;typeof Buffer=="function"&&Buffer.from?y=r:typeof Blob=="function"&&typeof URL=="function"&&typeof URL.createObjectURL=="function"&&(y=c),t.prototype.decode=function(o,f){if(f=f===void 0?{stream:!1}:f,f.stream)throw Error("Failed to decode: the 'stream' option is unsupported.");return o=o instanceof Uint8Array?o:o.buffer instanceof ArrayBuffer?new Uint8Array(o.buffer):new Uint8Array(o),y(o)},s.TextEncoder=e,s.TextDecoder=t})(typeof window<"u"?window:typeof global<"u"?global:globalThis);function A(s){return function(e,t){return Q(s,e!=null&&!Array.isArray(e)?[e]:e,t!=null&&!Array.isArray(t)?[t]:t)}}var K={"f64.const":q,"f32.const":S};function*Q(s,e=[],t=[]){for(let r of t)switch(typeof r){case"number":yield r;break;default:yield*r;break}yield d[s];for(let r of e)switch(typeof r){case"bigint":yield*M(r);break;case"number":yield*(K[s]??R)(r);break;default:yield*r}}var Z=new TextEncoder("utf-8");function T(s){return[...Z.encode(s)]}function D(){return[...T("\0asm"),1,0,0,0]}function h(s,e){return[d.section[s],...x(e.length),...e]}function b(s){return[...x(s.length),...s.flat()]}function ee(s){let e=[],t=[],r;for(let c of s)c!==r&&t.length&&(e.push([...x(t.length),d.type[t[0]]]),t=[]),t.push(c),r=c;return t.length&&e.push([...x(t.length),d.type[t[0]]]),e}function U(s,e,t){return t!=null?[d.limits.shared,...x(s),...x(e)]:e!=null?[d.limits.minmax,...x(s),...x(e)]:[d.limits.min,...x(s)]}h.type=function(s){return h("type",b(s.map(([e,t])=>[d.type.func,...b(e.map(r=>d.type[r])),...b(t.map(r=>d.type[r]))])))};h.import=function(s){return h("import",b(s.map(([e,t,r,c])=>[...b(T(e)),...b(T(t)),d.import[r],...{func:()=>c.map(_=>[...x(_)]),memory:()=>U(...c)}[r]()])))};h.function=function(s){return h("function",b(s.map(e=>[...x(e)])))};h.table=function(s){return h("table",b(s.map(([e,t,r])=>[d.type[e],...U(t,r)])))};h.memory=function(s){return h("memory",b(s.map(([e,t])=>U(e,t))))};h.global=function(s){return h("global",b(s.map(([e,t,r])=>[d.type[t],d.global[e],...r,d.end])))};h.export=function(s){return h("export",b(s.map(([e,t,r])=>[...b(T(e)),d.export[t],...x(r)])))};h.start=function(s){return h("start",[...x(s)])};h.element=function(s){return h("element",b(s.map(([e,t,r])=>[...x(e),...t,d.end,...b(r)])))};h.code=function(s){return h("code",b(s.map(([e,t])=>b([...b(ee(e)),...t,d.end]))))};h.data=function(s){return h("data",b(s.map(([e,t,r])=>[...x(e),...t,d.end,...b(r)])))};var $=class extends Array{log=[];write(e,t){return this.log.push(e,t),this.push(...e),this}get buffer(){return new Uint8Array(this)}},I=class{types=[];imports=[];tables=[];memories=[];globals=[];exports=[];starts="";elements=[];codes=[];datas=[];constructor(e){e&&Object.assign(this,e)}get funcs(){return this.codes.filter(e=>!e.imported)}ensureType(e,t){let r=[e.join(" "),t.join(" ")].join(),c=this.types.indexOf(r);return c>=0?c:this.types.push(r)-1}getGlobalIndexOf(e){return this.globals.find(t=>t.name===e).idx}getFunc(e){return this.codes.find(t=>t.name===e)}getMemory(e){return this.memories.find(t=>t.name===e)}getType(e){return this.types[e]}type(e,t,r){return this.types[e]=this.ensureType(t,r),this}import(e,t,r,c,_,g){if(e==="func"){let y=this._func(t,_,g,[],[],!1,!0);this.imports.push({mod:r,field:c,type:e,desc:[y.type_idx]})}else e==="memory"&&this.imports.push({mod:r,field:c,type:e,desc:_});return this}table(e,t,r){return this.tables.push({type:e,min:t,max:r}),this}memory(e,t,r){return this.memories.push({name:e,min:t,max:r}),this}global(e,t,r,c){let _=this.globals.length;return this.globals.push({idx:_,name:e,valtype:r,mut:t,expr:c}),this}export(e,t,r){return this.exports.push({type:e,name:t,export_name:r}),this}start(e){return this.starts=e,this}elem(e,t){return this.elements.push({offset_idx_expr:e,codes:t}),this}_func(e,t=[],r=[],c=[],_=[],g=!1,y=!1){let o=this.ensureType(t,r),i={idx:this.codes.length,name:e,type_idx:o,locals:c,body:_,imported:y};return this.codes.push(i),g&&this.export("func",e,e),i}func(...e){return this._func(...e),this}data(e,t){return this.datas.push({offset_idx_expr:e,bytes:t}),this}build({metrics:e=!0}={}){e&&console.time("module build");let t=new $;return t.write(D()),this.types.length&&t.write(h.type(this.types.map(r=>r.split(",").map(c=>c.split(" ").filter(Boolean))))),this.imports.length&&t.write(h.import(this.imports.map(r=>[r.mod,r.field,r.type,r.desc]))),this.funcs.length&&t.write(h.function(this.funcs.map(r=>r.type_idx))),this.elements.length&&t.write(h.table(this.tables.map(r=>[r.type,r.min,r.max]))),this.memories.length&&t.write(h.memory(this.memories.map(r=>[r.min,r.max]))),this.globals.length&&t.write(h.global(this.globals.map(r=>[r.mut,r.valtype,r.expr]))),this.exports.length&&t.write(h.export(this.exports.map(r=>r.type==="func"?[r.export_name,r.type,this.getFunc(r.name).idx]:r.type==="memory"?[r.export_name,r.type,this.getMemory(r.name).idx]:r.type==="global"?[r.export_name,r.type,this.getGlobalIndexOf(r.name)]:[]))),this.starts.length&&t.write(h.start(this.getFunc(this.starts).idx)),this.elements.length&&t.write(h.element(this.elements.map(r=>[0,r.offset_idx_expr,r.codes.map(c=>this.getFunc(c).idx)]))),this.funcs.length&&t.write(h.code(this.funcs.map(r=>[r.locals,r.body]))),this.datas.length&&t.write(h.data(this.datas.map(r=>[0,r.offset_idx_expr,r.bytes]))),e&&console.timeEnd("module build"),t}};var E=class{globals=[];types=[];funcs=[];constructor(e){e&&(Object.assign(this,e),this.funcs.forEach(t=>{t.context=new B(this,t.context)}))}lookup(e,t){let r;switch(t){case"call":r=this.funcs.map(c=>c.name).lastIndexOf(e);break;case"type":r=this.types.map(c=>c.name).lastIndexOf(e);break;default:r=this.globals.map(c=>c.name).lastIndexOf(e)}if(!~r)throw new ReferenceError(`lookup failed at: ${t} "${e}"`);return x(r)}},B=class{#e=null;locals=[];depth=[];constructor(e,t){this.#e=e,t&&Object.assign(this,t)}lookup(e,t){let r;switch(t){case"br":case"br_table":case"br_if":r=this.depth.lastIndexOf(e),~r&&(r=this.depth.length-1-r);break;default:r=this.locals.lastIndexOf(e)}return~r?x(r):this.#e.lookup(e,t)}};function F(s,e,t){let r=new I(e),c=new E(t),_=[];function g(i,n=c,u="i32"){switch(i.kind){case"number":{if(i.value==="inf"||i.value==="+inf")return 1/0;if(i.value==="-inf")return-1/0;if(i.value==="nan"||i.value==="+nan")return NaN;if(i.value==="-nan")return NaN;if(u?.[0]==="f")return parseFloat(i.value)}case"hex":{let a;return u.indexOf("i64")===0?(i.value[0]==="-"?a=-BigInt(i.value.slice(1)):a=BigInt(i.value),a):u[0]==="f"?(i.value.indexOf("nan")>=0?u.indexOf("f32")===0?a=G(i.value):a=P(i.value):a=C(i.value),a):parseInt(i.value)}case"label":return n.lookup(i.value,u);default:return i.value}}function y(i,n,u){if(!(i in v)||typeof v[i]!="function")throw new Error("Unknown instruction: "+i);return[...v[i](n,u)]}function o(i,n=c){let u={offset:0,align:0},a=i.instr.value;switch(a){case"type":return r.getType(i.name.value);case"call_indirect":{let l=[o(i.children.shift(),n),0],p=i.children.flatMap(m=>o(m,n));return y(a,l,p)}case"memory.grow":{let l=[0],p=i.children.flatMap(m=>o(m,n));return y(a,l,p)}case"i32.load":case"i64.load":case"f32.load":case"f64.load":case"i32.load8_s":case"i32.load8_u":case"i32.load16_s":case"i32.load16_u":case"i64.load8_s":case"i64.load8_u":case"i64.load16_s":case"i64.load16_u":case"i64.load32_s":case"i64.load32_u":case"i32.store":case"i64.store":case"f32.store":case"f64.store":case"i32.store8":case"i32.store16":case"i64.store8":case"i64.store16":case"i64.store32":{u.align=L[a];for(let m of i.params)u[m.param.value]=g(m.value);let l=[Math.log2(u.align),u.offset].map(m=>{if(typeof m=="number")return x(m);if(typeof m=="bigint")return M(m)}),p=i.children.flatMap(m=>o(m,n));return y(a,l,p)}case"func":{let l={name:i.name?.value??c.funcs.length,params:[],results:[]};c.funcs.push(l);for(let p of i.children)switch(p.instr.value){case"param":l.params.push(...p.children.map(m=>m.instr.value));break;case"result":l.results.push(...p.children.map(m=>m.instr.value));break}return[l.name,l.params,l.results]}case"result":return i.children.flatMap(l=>v.type[l.instr.value]());case"else":case"then":return i.children.flatMap(l=>o(l,n));case"if":{let l=i.name?.value??n.depth.length,p=[],m=[],w;n.depth.push(l);for(let O of i.children)switch(O.instr.value){case"result":p.push(o(O,n));break;case"else":m.push(...v.else());case"then":m.push(o(O,n));break;default:w=o(O,n)}return n.depth.pop(),p.length||p.push(v.type.void()),[...v.if(p.flat(),w),...m.flat(),...v.end()]}case"loop":case"block":{let l=i.name?.value??n.depth.length,p=[],m=[];n.depth.push(l);for(let w of i.children)switch(w.instr.value){case"result":p.push(o(w,n));break;default:m.push(o(w,n))}return n.depth.pop(),p.length||p.push(v.type.void()),[...v[a](),...p.flat().map(w=>[...w]),...m.flat(),...v.end()]}case"br_table":{i.name&&i.params.unshift({param:{value:n.lookup(i.name.value,a)}});let l=i.params.map(m=>g(m.param,n,a)),p=i.children.flatMap(m=>o(m,n));return y(a,[l.length-1,...l],p)}default:{i.name&&i.params.unshift({param:{value:(a.startsWith("global")?c:n).lookup(i.name.value,a)}});let l=i.params.map(m=>g(m.param,n,a)),p=i.children.flatMap(m=>o(m,n));return y(a,l,p)}}}function f(i){switch(i.instr.value){case"module":i.children.forEach(n=>f(n));break;case"memory":{let n=i.name?.value??r.memories.length,u=i.params.map(a=>g(a.param)).flat();if(i.children?.[0]?.instr.value==="export"){let a=i.children[0].params[0].param.value,l=i.children[0].name?.value??0;r.export("memory",l,a)}r.memory(n,...u)}break;case"data":{let n=i.children.shift(),u=i.children.shift().data;r.data(o(n),u)}break;case"start":r.start(i.name.value);break;case"table":{let n=i.params.map(u=>g(u.param));n.unshift(n.pop()),r.table(...n)}break;case"elem":{let n=i.children.shift(),u=i.children.map(a=>a.ref.value);r.elem(o(n),u)}break;case"import":if(i.children[0].instr.value==="func"){let n=i.params.map(l=>g(l.param)),u=o(i.children[0]),a=u.shift();r.import("func",a,...n,...u)}else if(i.children[0].instr.value==="memory"){let n=i.children[0],u=i.params.map(p=>g(p.param)),a=n.instr.name,l=n.params.map(p=>g(p.param));r.import("memory",a,...u,l)}break;case"global":{let n={name:i.name?.value??r.globals.length,vartype:"const",type:i.children[0].instr.value};if(c.globals.push(n),n.type==="export"){let a=i.children.shift().params[0].param.value;r.export("global",n.name,a),n.type=i.children[0].instr.value}n.type==="mut"&&(n.vartype="var",n.type=i.children[0].children[0].instr.value);let u=i.children[1];r.global(n.name,n.vartype,n.type,o(u))}break;case"type":{let n={name:i.name?.value??r.types.length,params:[],results:[]};c.types.push(n);for(let u of i.children[0].children)switch(u.instr.value){case"param":n.params.push(...u.children.map(a=>a.instr.value));break;case"result":n.results.push(...u.children.map(a=>a.instr.value));break}r.type(n.name,n.params,n.results)}break;case"export":{let n={name:i.params[0].param.value};n.type=i.children[0].instr.value,n.internal_name=i.children[0].name.value,r.export(n.type,n.internal_name,n.name)}break;case"func":{let n={name:i.name?.value??c.funcs.length,context:new B(c),params:[],results:[],locals:[],body:[]};c.funcs.push(n);for(let u of i.children)switch(u.instr.value){case"export":{let a=u.params[0].param.value;r.export("func",n.name,a)}break;case"local":n.locals.push(...u.children.map(a=>a.instr.value)),n.context.locals.push(...u.children.map(()=>u.name?.value));break;case"param":n.params.push(...u.children.map(a=>a.instr.value)),n.context.locals.push(...u.children.map(()=>u.name?.value));break;case"result":n.results.push(...u.children.map(a=>a.instr.value));break;default:n.body.push(u)}_.push(()=>{r.func(n.name,n.params,n.results,n.locals,[...n.body.flatMap(u=>o(u,n.context))])})}break}}return f(s),_.forEach(i=>i()),{module:r,global:c}}var te=new RegExp([/(?<comment>;;.*|\(;[^]*?;\))/,/"(?<string>(?:\\"|[^"])*?)"/,/(?<param>offset|align|shared|funcref)=?/,/(?<hex>([+-]?nan:)?[+-]?0x[0-9a-f.p+-_]+)/,/(?<number>[+-]?inf|[+-]?nan|[+-]?\d[\d.e_+-]*)/,/(?<instr>[a-z][a-z0-9!#$%&'*+\-./:<=>?@\\^_`|~]+)/,/\$(?<label>[a-z0-9!#$%&'*+\-./:<=>?@\\^_`|~]+)/,/(?<lparen>\()|(?<rparen>\))|(?<nul>[ \t\n]+)|(?<error>.)/].map(s=>s.toString().slice(1,-1)).join("|"),"gi");function V(s){let e={},t={},r=s.matchAll(te);function c(){let i=r.next();if(i.done)return{value:{value:null,kind:"eof",index:s.length},done:!0};let[n,u]=Object.entries(i.value.groups).filter(a=>a[1]!=null)[0];return{value:{value:u,kind:n,index:i.value.index},done:!1}}function _(){e=t;do t=c().value;while(t.kind==="nul"||t.kind==="comment");return e}function g(i,n){return i!=null?n!=null?n===t.value:i===t.kind:t}function y(i,n){if(i===t.kind)if(n!=null){if(n===t.value)return _()}else return _();return null}function o(i,n){let u=y(i,n);if(!u)throw new SyntaxError("Unexpected token: "+t.value+`
        expected: `+i+(n?' "'+n+'"':"")+`
    but received: `+t.kind+`
     at position: `+t.index);return u}return{[Symbol.iterator](){return this},next:c,advance:_,peek:g,accept:y,expect:o,start:_}}function j({start:s,peek:e,accept:t,expect:r}){let c=new TextEncoder("utf-8");function _(){let o=[];for(;;){let f=t("string");if(!f)break;if(f.value[0]==="\\"&&f.value[1].match(/[0-9a-f]/i)){let i=f.value.matchAll(/\\([0-9a-f]{1,2})/gi);for(let n of i)o.push(parseInt(n[1],16))}else f.value=f.value.replace(/\\n/,`
`),o.push(...c.encode(f.value))}return o}function*g(){let o;for(;;){if(o=t("number")){o.value=o.value.replace(/_/g,""),yield{param:o};continue}if(o=t("hex")){o.value=o.value.replace(/_/g,""),yield{param:o};continue}if(o=t("string")){yield{param:o};continue}if(o=t("label")){yield{param:o};continue}if(o=t("param")){let f;if(f=t("number")){yield{param:o,value:f};continue}if(f=t("hex")){yield{param:o,value:f};continue}else{yield{param:o};continue}}break}}function y(){let o=t("label");if(o)return{ref:o};if(e("string"))return{data:_()};let f=t("lparen"),i;if(f)i=r("instr");else if(i=t("instr"),!i)return;let n={instr:i,name:t("label"),params:[...g()],children:[]};if(f){let u;for(;!e("eof")&&(u=y());)n.children.push(u);n.params.push(...g()),r("rparen")}else if(i.value==="block"||i.value==="loop"){let u;for(;!e("eof")&&!e("instr","end")&&(u=y());)n.children.push(u);r("instr","end")}return n}return s(),y()}function re(s,e,t={}){return F(j(V("(module "+s+")")),t.module,t.global).module.build(e).buffer}export{E as GlobalContext,I as ModuleBuilder,F as compile,re as default,j as parse,V as tokenize};
